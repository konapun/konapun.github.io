{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/improving-code-with-functional-features/","result":{"data":{"markdownRemark":{"id":"e73056fe-8870-596e-b8d4-a2b9124a8b2e","excerpt":"Like many developers, I have a very specific setup which has been evolving over the years. I spend my computing time bouncing between macOS,\nWindows 10, and…","html":"<p>Like many developers, I have a <a href=\"https://github.com/konapun/dotfiles\" target=\"_blank\" rel=\"noopener noreferrer\">very specific setup</a> which has been evolving over the years. I spend my computing time bouncing between macOS,\nWindows 10, and various Linux so one of my goals is to be able to run my custom development environment on all three platforms and to build it with minimal dependencies.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/8ebf30d07f0a8828bf5f80122a6adafd/3b25c/monokai-theme.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABn0lEQVQozz1S2W7bMBDUV9ixdfCWROoibTiQj7QF4qBBCrTv/f//mI4ZNA8LULPk7MysinR5xfHlB8bDHfGcEC8G6doiXi3aXmM93TBPC1xrYVlCSUhtMEwjyrrBvqpzlXUNGxoUwyGgjzsCWwhTYrOpsN2ynmooYzDOI/w0oA+BhB20M5CKhPzuvee3RcMhtVAkFihKVUF7heoBmgY7TqqE4AUJYw2WZcEUI8Zlgg8+kzZSUbVHOkZ0xKRWVG4yXgThMOoOi/EIjUMnDJTSmdDxcUyRhAm281SicwnWMA4Y5ol4B+Ucq4VgFEXSAyYRcJQOqdHwpUJTNbmpOHVmVkMc0YY+Y/tHTyksKSEwDmUdo3IcZOhMonhLN3z/FfHyMyEd3hDWb7SvqICXjWV2LUzLB1J+LeFhzbVttlrmpVR5KVXDDD/cAfc/Cq/vKy6nv0j33yippGZTam66cwyeNqXOZLvyk6D6Otd5gZvtHk88F9fbGcd1xXxqoe2n9P+W+tDRqoXrHaRRHCDZE+i6gBAtpJVZ+XKWeL7xl+s9/gGjcubZ8nf8ngAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"monokai\" title=\"monokai\" src=\"/static/8ebf30d07f0a8828bf5f80122a6adafd/fcda8/monokai-theme.png\" srcset=\"/static/8ebf30d07f0a8828bf5f80122a6adafd/12f09/monokai-theme.png 148w,\n/static/8ebf30d07f0a8828bf5f80122a6adafd/e4a3f/monokai-theme.png 295w,\n/static/8ebf30d07f0a8828bf5f80122a6adafd/fcda8/monokai-theme.png 590w,\n/static/8ebf30d07f0a8828bf5f80122a6adafd/efc66/monokai-theme.png 885w,\n/static/8ebf30d07f0a8828bf5f80122a6adafd/c83ae/monokai-theme.png 1180w,\n/static/8ebf30d07f0a8828bf5f80122a6adafd/3b25c/monokai-theme.png 3440w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n<hr>\n<h3>Selecting a Language</h3>\n<p>My main requirements for selecting a configuration language were 1) It should be ubiquitous and 2) It should have good interaction with system utilities, which made shell scripting,\nin this case zsh, a good fit.</p>\n<h3>Theming</h3>\n<p>Eventually, I wanted to be able to theme my configuration which meant setting points in my config files where new values could be inserted. Since I was already using zsh, I decided\nto make a simple theme engine using <a href=\"https://www.gnu.org/software/sed/manual/sed.html\" target=\"_blank\" rel=\"noopener noreferrer\">sed</a>.</p>\n<h4>Implementation in zsh</h4>\n<p>The simplified version of the code for setting the values and cleaning up unsubstituted variables is below.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Apply a value for a variable in a config file</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-name function\">themer_substitute</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">key</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n  <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">value</span><span class=\"token operator\">=</span><span class=\"token variable\">$2</span>\n  <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">file</span><span class=\"token operator\">=</span><span class=\"token variable\">$3</span>\n\n  <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"{{<span class=\"token variable\">$key</span>}}\"</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> -z <span class=\"token variable\">$value</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sed</span> -i -- <span class=\"token string\">\"s&amp;<span class=\"token variable\">$pattern</span>&amp;<span class=\"token variable\">$value</span>&amp;g\"</span> <span class=\"token variable\">$file</span> <span class=\"token operator\">&amp;></span> /dev/null\n  <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Remove all unreplaced template variables</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-name function\">themer_cleanup</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">file</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n\n  <span class=\"token function\">sed</span> --in-place <span class=\"token string\">'/{{.*}}/d'</span> <span class=\"token variable\">$file</span> <span class=\"token operator\">&amp;></span> /dev/null <span class=\"token comment\"># delete whole line with unsubstituted {{variable}}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Usage in zsh</h4>\n<p>Variables are inserted into config files by surrounding a key to be replaced with double curlies.\nHere is an example from my neovim config file:</p>\n<div class=\"gatsby-highlight\" data-language=\"vim\"><pre class=\"language-vim\"><code class=\"language-vim\"><span class=\"token comment\">\" set theme</span>\n<span class=\"token keyword\">set</span> <span class=\"token builtin\">background</span><span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>background_color<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">set</span> termguicolors\n<span class=\"token builtin\">syntax</span> enable\n<span class=\"token keyword\">colorscheme</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>syntax_theme<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>I then use the themer in my install step to set the values which are sourced from the theme files.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">themer_substitute background_color <span class=\"token variable\">$BACKGROUND_COLOR</span> <span class=\"token variable\">$CONFIG_FILE</span>\nthemer_substitute syntax_theme <span class=\"token variable\">$SYNTAX_THEME</span> <span class=\"token variable\">$CONFIG_FILE</span>\nthemer_cleanup <span class=\"token variable\">$CONFIG_FILE</span></code></pre></div>\n<p>This works well and fulfills my goals but having to call the function with the key, value, and the config file upon each invocation and needing to call the cleanup function on the\nfile when finished makes me think this could be done better if zsh supported first class functions.</p>\n<h3>A Brief Primer on First Class Functions</h3>\n<p>A function being “first class” means it can be passed to a function as an argument and also be returned from a function. Even if you haven’t used this terminology directly you’re\nprobably used to using them in the form of callbacks. They’re also useful for decorating functions with additional functionality.</p>\n<p>A closure is a type of first class function where one or more values is “closed over”, meaning the function carries its own scope with bound variables.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">makeTimedFunction</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">fn</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> start <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> elapsed <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Executed in </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>elapsed<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> ms</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">myFunction</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">timeout</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">const</span> timedFunction <span class=\"token operator\">=</span> <span class=\"token function\">makeTimedFunction</span><span class=\"token punctuation\">(</span>myFunction<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">timedFunction</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// logs \"Executed in 2000 ms\"</span></code></pre></div>\n<h3>An Implementation Using First Class Functions</h3>\n<p>So how might I achieve a more succinct API if I were using a more expressive language?</p>\n<p>From the motivating example, one of the things I wanted to improve was doing an automatic cleanup after theming - no more having to remember to call <code class=\"language-text\">themer_cleanup</code>. If we have\nfirst class function support then we can wrap the original function with a cleanup step. Using a closure we can avoid having to pass the config file to the function on every call..</p>\n<h4>The engine code</h4>\n<p>Here is an example of how we could rewrite the themer in a javascript-like languge.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// utils/themer</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">cleanup</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">file</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// implementation details left out for brevity</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">path<span class=\"token punctuation\">,</span> configFn</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token string\">'r+'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> engine <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">set</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      file<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">{{</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>key<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">}}</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span> <span class=\"token comment\">// `file.replace` is a hypothetical function used here to illustrate the use of a closure to simplify the client API</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">configFn</span><span class=\"token punctuation\">(</span>engine<span class=\"token punctuation\">)</span> <span class=\"token comment\">// run client code</span>\n\n  <span class=\"token function\">cleanup</span><span class=\"token punctuation\">(</span>configFile<span class=\"token punctuation\">)</span> <span class=\"token comment\">// remove unsubstituted lines from the configuration</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Usage</h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> theme <span class=\"token keyword\">from</span> <span class=\"token string\">'../utils/themer'</span>\n\n<span class=\"token function\">theme</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">CONFIG_FILE</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">engine</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  engine<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'background_color'</span><span class=\"token punctuation\">,</span> env<span class=\"token punctuation\">.</span><span class=\"token constant\">BACKGROUND_COLOR</span><span class=\"token punctuation\">)</span>\n  engine<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'syntax_theme'</span><span class=\"token punctuation\">,</span> env<span class=\"token punctuation\">.</span><span class=\"token constant\">SYNTAX_THEME</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this example, the <code class=\"language-text\">theme</code> function initializes the file, gives us a theming API to run in our function, runs our function, and automatically cleans up when our function has\nfinished executing.</p>\n<p>It’s not always feasible to choose a language based on expressive power alone but even when it’s not, it’s still a fun practice to think about how functional techniques can be\nused to improve code.</p>","frontmatter":{"title":"Using Functional Features to Improve Code","date":"April 02, 2021","description":"An example driven solution","tags":["dev notes"]}},"allMarkdownRemark":{"edges":[{"node":{"excerpt":"Like many developers, I have a very specific setup which has been evolving over the years. I spend my computing time bouncing between macOS…","fields":{"slug":"/improving-code-with-functional-features/"},"frontmatter":{"date":"April 02, 2021","title":"Using Functional Features to Improve Code","description":"An example driven solution"}}},{"node":{"excerpt":"ALL INFO IS BRAINSTORMING AND SUBJECT TO CHANGE Like many self-proclaimed techies, especially those with an affinity for Linux, I enjoy…","fields":{"slug":"/ideas-for-a-new-templating-language/"},"frontmatter":{"date":"November 12, 2020","title":"Ideas For a New Templating Language","description":"Designing a non-destructive templating system by use of an informed compiler"}}},{"node":{"excerpt":"Recently, someone asked on a programming subreddit if there was a way in a node\nExpress app to reduce duplicated error handling logic when…","fields":{"slug":"/using-proxy-objects/"},"frontmatter":{"date":"June 16, 2020","title":"Using Proxy Objects","description":"A problem and solution using a Proxy"}}},{"node":{"excerpt":"After years of on and off work, Orbital Frame has been released to npm as an alpha! For full details, check out the GitHub repo and try an…","fields":{"slug":"/introducing-orbital-frame/"},"frontmatter":{"date":"May 15, 2020","title":"Introducing Orbital Frame","description":"Unleash the power of UNIX in your chatbot!"}}},{"node":{"excerpt":"Figured I’d throw a quick site together to host project demos. This site is\npowered by Gatsby and is based on a modified mashup of\ngatsby…","fields":{"slug":"/hello-world/"},"frontmatter":{"date":"April 19, 2020","title":"Hello World","description":"A bit about this site"}}}]}},"pageContext":{"back":"/blog","slug":"/improving-code-with-functional-features/","previous":{"fields":{"slug":"/ideas-for-a-new-templating-language/"},"frontmatter":{"title":"Ideas For a New Templating Language"}},"next":null}},"staticQueryHashes":["2841359383","2841359383","3649515864"]}